# 3.2 부분 범위 처리 활용

# 3.2.1 부분범위 처리

부분범위처리란 전체 쿼리 집합을 쉼 없이 연속적으로 전송하지 않고 사용자로 부터 Fetch Call이 있을때 마다 **일정량**씩 나누어 전송하는 것이다.

- 1억건에 이르는 대용량 테이블이어도 실행 결과는 바로 출력된다.
    - DBMS가 데이터를 모두 읽어 한 번에 전송하지 않고 먼저 읽는 데이터부터 일정량 (Array Size)을 전송하고 멈추기 떄문이다.
    - 다음 Fetch Call을 받으면 대기 큐에서 나와 그 다음데이터 부터 일정량을 읽어서 전송한다.

**정렬 조건이 있을 떄 부분범위 처리**

```java
Statement stmt = connection.createStatment();
ResultSet resultSet = stmt.executeQuery("SELECT name FROM bug_table ORDER BY created");
```

- 위 ORDER BY 조건인 created 컬럼이 선두인 인덱스가 있을 경우 부분범위 처리가 가능하다. 인덱스는 항상 정렬된 상태를 유지하므로 전체 데이터를 정렬하지 않고도 정렬된 상태의 결과집합을 바로 전송할 수 있다.

**Array Size 조정을 통한 Fetch Call 최소화**

- 대량 데이터를 파일로 내려받는다면 모든 데이터가 필요하므로 가급적 Array Size를 크게 설정해야한다. Array Size를 조정한다고 해서 전송해야 할 총량이 변하지 않지만, Fetch Call 회수를 줄일 수있다.
- 일부 데이터만 Fetc하다가 멈추는 프로그램이라면 Array Size를 작게 설정하여 불필요하게 많은 데이터를 전송하고 버리는 비효율을 줄일 수 있다.

**쿼리 툴에서 부분범위 처리**

- IntelliJ에서 SQL문을 사용하여 조회하면 0.01초가 걸리면서 500개만 가져오게 되어있다.

# 3.2.2 부분범위 처리 구현

- Page 164 ~ 165 참고
- 개발자가 일일이 구현할 수 없고, 개발 프레임워크에 미리 구현돼있는 기능을 활용한다.

# 3.2.3 환경에서 부분범위 처리에 의한 개선 원리

OLT는 Online Transaction Processing의 줄임말이다. 

- OLTP는 일반적으로 소량 데이터를 읽고 갱신하지만 항상 소량에 데이터만을 조회하는것만은 아니다.
- OLTP는 은행계좌 입출금 조회, 뉴스 또는 게시판과 같이 특정한 정렬 순서로 상위 일부 데이터만 확인한다.
- 인덱스와 부분범위 처리 원리를 잘 활용하면 OLTP 환경에서 극정인 성능개선 효과를 얻을 수 있다.

**멈출 수 있어야 의미있는 부분범위 처리**

- 부분범위 처리의 핵심은 앞쪽 일부만 출력하고 멈출 수 있는가이다.

**배치 I/O**

> 배치 I/O는 읽는 블록마다 건건 I/O Call을 발생시키는 비효율을 줄이기 위해 고안한 기능이다.
> 
> 
> 테이블 블록에 대한 디스크 I/O Call을 미뤘다가 읽을 블록이 일정량 쌓이면 한꺼번에 처리한다.
> 
> **데이터 정렬 이슈**
> 
> - 배치 I/O 기능이 작동하면 인덱스를 이용해서 출력하는 데이터 정렬 순서가 매번 다를 수 있다.
> - 배치 I/O를 통해 얻을 수 있는 성능이 많음에도 불구하고 시스템 레벨에서 이를 비활성화 하는 경우가 있음
> - 이유는 필요한 ORDER BY를 생략한 SQL 패턴 때문이다.
> - SQL에 ORDER BY가 없으면 결과 집합의 정렬 순서를 보장할 필요가 없으므로 옵티마어저가 배치 I/O를 선택할 수 있고, 출력된 결과 집합의 정렬 순서가 매번 다를 수 있다.
> - 인덱스 정렬 순서를 믿고 ORDER BY를 생략하는 개발 패턴은 피하는것이 좋다.